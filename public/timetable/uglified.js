"use strict";const $=require("jquery");require("bootstrap");const dialogPolyfill=require("dialog-polyfill");require("bootstrap-notify");const ProgramSearcher=require("../../modules/ProgramSearcher"),ProcessCommunicator=require("../../modules/ProcessCommunicator"),IpcClient=require("../../modules/IpcClient"),DlNotification=require("../../modules/DlNotification"),FirebaseClient=require("../../modules/FirebaseClient"),Util=require("../../modules/Util"),DomUtil=require("../../modules/DomUtil"),{EreaChecker:EreaChecker,ProgramListGetter:ProgramListGetter}=require("../../modules/Network");window.eval=global.eval=function(){throw new Error("Sorry, this app does not support window.eval().")},$(()=>{const t=require("moment");class e{constructor(){this.tabBar=$(".mdl-layout__tab-bar"),this.$root=$(".mdl-layout__content"),this.$header=$("#header-table-out"),this.headerWid=this.$header.find("span").width()/2,this.$footer=$("#footer-table-out"),this.footerWid=this.$footer.find("span").width()/2,this.$timeTable=$("#mix-table"),this.$spinner=$(".mdl-spinner"),this.$calendarMenu=$("#calendar-menu"),this.$stationMenu=$("#station-menu"),this.$grid=$("#grid"),this.currentM=t(),this.currentM.hour()<5&&this.currentM.add(-1,"d"),console.log(this.currentM),this.$dialog=$(".mdl-dialog"),Util.setUpDialog(dialogPolyfill,this.$dialog[0])}init(){this.$root.scroll(()=>{this.centerHeadAndFoot(this.$root)}),$(window).resize(()=>{this.centerHeadAndFoot(this.$root)}),this.centerHeadAndFoot()}centerHeadAndFoot(){console.log("スクロール発火");const t=this.$root.scrollLeft();this.tabBar.scrollLeft(t);const e=$(window).width()/2+t;this.$header.find("span").css("left",e-this.headerWid),this.$footer.find("span").css("left",e-this.footerWid)}scrollTopOffset(){this.$root.scrollTop(72)}scrollToMostRight(){this.$root.scrollLeft(this.$root.width())}show(){this.$root.removeClass("shown-spinner"),this.$timeTable.show(),$(".mdl-layout__tab").css("display","inline"),$(".optional-btn").removeAttr("disabled")}setOnLoadingMode(){$(".mdl-layout__tab").hide(),this.$timeTable.hide(),this.$root.addClass("shown-spinner"),$(".optional-btn").prop("disabled",!0)}resetAllDoms(){$(".mdl-layout__tab").remove(),this.$grid.children().remove(),this.$header.hide(),this.$footer.hide()}removeAllDoms(){this.$timeTable.hide(),this.$grid.empty(),this.$root.addClass("shown-spinner"),$(".mdl-layout__tab").remove(),this.$stationMenu.empty()}setOnClickListenersForFrame(){const e=this;$("#header-table-out").on("click",()=>{this.currentM.add(-1,"d"),r.changeDate()}),$("#footer-table-out").on("click",()=>{this.currentM.add(1,"d"),r.changeDate()}),$("#calendar-menu .mdl-menu__item").on("click",i=>{if(console.log($(i.currentTarget).attr("id")),$(i.currentTarget).prop("disabled"))return!1;$(i.currentTarget).parents(".mdl-menu__container").removeClass("is-visible");const o=$(i.currentTarget).attr("date");e.currentM=t(o,"YYYYMMDD"),r.changeDate()}),Util.setDialogListeners(this.$dialog[0]),$("#dl-btm").on("click",()=>{e.$dialog[0].close();const t=e.$dialog.attr("ft"),i=e.$dialog.attr("station"),o=e.$dialog.attr("data-title"),n=e.$dialog.attr("to"),a=e.$dialog.attr("data-img");s.callDL(t,n,i,o,a)})}setOnClickPostGetPrg(){$(".mdl-layout__tab").on("click",t=>{const e=$(t.currentTarget).attr("id"),i=$(t.currentTarget).attr("data-name");return console.log(e),r.startChangeToStationTable(e,i),!1}),this.setOnStMenuItemClick()}setOnStMenuItemClick(){$("#station-menu .mdl-menu__item").on("click",t=>{const e=$(t.currentTarget).attr("station"),i=$(t.currentTarget).attr("data-name");console.log(e),$(this).prop("disabled")||$(this).parents(".mdl-menu__container").removeClass("is-visible"),r.startChangeToStationTable(e,i)})}disableStMenuItem(t){let e=[];this.$stationMenu.children().each((i,o)=>{const s=$(o).attr("station"),n=$(o).attr("data-name"),a='<li class="mdl-menu__item mdl-pre-upgrade" station="'+s+'" data-name="'+n+'" '+(t===s?"disabled":"")+">"+n+"</li>";e.push(a)}),this.$stationMenu.children().remove();for(let t=0;t<e.length;t++)this.$stationMenu.append($(e[t]));Util.setElementAsMdl(this.$stationMenu),this.setOnStMenuItemClick()}static setToolbarTitle(t,e){if(e){const t="http://radiko.jp/station/logo/"+e+"/logo_medium.png";$(".mdl-layout-title img").attr("src",t).show(),$(".mdl-layout-title span").html("")}else $(".mdl-layout-title img").hide(),$(".mdl-layout-title span").html(t)}initDateMenu(){const t=a.currentM.clone();for(let e=0;e<8;e++){let i=Util.getMDWithWeekDay(t);const o=$('<li class="mdl-menu__item mdl-pre-upgrade" date="'+t.format("YYYYMMDD")+'">'+i+"</li>");0===e&&o.addClass("current").attr("disabled",!0),this.$calendarMenu.prepend(o),t.add(-1,"d")}}updateDateMenu(t){console.log(a.currentM.format("YYYYMMDD")),this.$calendarMenu.find(".mdl-menu__item.current").removeAttr("disabled").removeClass("current");const e=this.$calendarMenu.find('.mdl-menu__item[date="'+a.currentM.format("YYYYMMDD")+'"]').addClass("current").attr("disabled",!0);if(!t)return;const i=e.index();0===i?this.$header.hide():this.$header.show(),6===i?this.$footer.hide():this.$footer.show()}setOnCardClickListener(){const i=this;$(".prg-card-w").on("click",function(o){if(o.preventDefault(),console.log("click"),i.$dialog.prop("open"))return!1;const s=$(this).find(".prg-title").html(),n=$(this).find(".info_group .ft").html(),a=$(this).find(".info_group .to").html(),r=$(this).find(".info_group .info").html(),l=$(this).find(".info_group .desc").html(),d=$(this).find(".info_group .pfm").html(),c=$(this).find(".info_group .img").html(),h=$(this).find(".info_group .url").html();i.$dialog.find(".prg-logo").removeAttr("src").attr("src",c),i.$dialog.find(".title").html(s),i.$dialog.find(".performer").html(d),i.$dialog.find(".hp a").html(h),i.$dialog.find(".date").html(e.getDialogDate(n,a)),i.$dialog.find(".desc").empty().append(Util.wrapHtml(l)),i.$dialog.find(".info").empty().html(Util.wrapHtml(r)),i.$dialog.attr("ft",n).attr("station",$(this).attr("station")).attr("data-title",s).attr("to",a).attr("data-img",c),$(this).hasClass("cant-dl")&&i.$dialog.find("#dl-btm");const m=i.$dialog.find("#dl-btm"),u=i.$dialog.find(".error-msg");return $(this).hasClass("cant-dl")?(m.hide(),u.html("この番組はタイムフリー非対応です").show()):t(n,"YYYYMMDDhhmmss").diff(t())>0?(m.hide(),u.html("この番組はまだ配信されていません").show()):t(a,"YYYYMMDDhhmmss").diff(t())>0?(m.hide(),u.html("放送中の番組はダウンロードできません").show()):(m.show(),u.html("").hide()),i.$dialog[0].showModal(),!1})}static getDialogDate(e,i){const o=t(e,"YYYYMMDDhhmmss"),s=t(i,"YYYYMMDDhhmmss");return o.format("M/D")+"("+Util.getWeekDays()[o.day()]+") "+o.format("HH:mm")+" - "+s.format("HH:mm")}}class i extends DomUtil{constructor(t){super();const e=$(t).find("station");this.stationId=e.attr("id"),this.stationName=e.find("name").eq(0).html(),this.$prgs=e.find("progs")}init(){this.setColumnLen(8),e.setToolbarTitle(this.stationName,this.stationId),this.setGridCss(),this.setGridCells(),this.inputTabs(),this.inputCards()}inputTabs(){const e=this.currentM.clone();console.log("inputTabs",e.format("YYYYMMDD"));const i=$(".mdl-layout__tab-bar");for(let t=0;t<8;t++){console.log(e.format("YYYYMMDD"));const t=Util.getMDWithWeekDay(e),o=$('<a href="javascript: void(0)" class="mdl-layout__tab mdl-pre-upgrade" data-ymd="'+e.format("YYYYMMDD")+'">'+t+"</a>");0===e.day()&&o.addClass("holiday"),i.prepend(o),e.add(-1,"d")}i.find(".mdl-layout__tab").on("click",e=>(this.currentM=t($(e.currentTarget).attr("data-ymd"),"YYYYMMDD"),r.changeDate(),!1))}inputCards(){const t=this.currentM.clone();t.add(-7,"d");for(let e=0;e<8;e++){const i=this.$prgs.find("date:contains("+t.format("YYYYMMDD")+")").parent().find("prog");this.inputEachCard(i,e,this.stationId),t.add(1,"d")}}}class o extends DomUtil{constructor(t){super(),this.$stations=$(t).find("stations station")}init(){this.setColumnLen(this.$stations.length);const t=Util.getMDWithWeekDay(this.currentM);e.setToolbarTitle(t),this.setGridCss(),this.setGridCells(),this.inputCards(),a.setOnClickPostGetPrg(),Util.setElementAsMdl($(document))}inputCards(){console.log(this.$stations);const t=$(".mdl-layout__tab-bar"),e=$("#station-menu");this.$stations.each((i,o)=>{const s=$(o).attr("id"),n=$(o).find("name").html(),a=$(o).find("progs"),r=$('<a href="javascript: void(0)" class="mdl-layout__tab mdl-pre-upgrade" id="'+s+'" data-name="'+n+'">\n<img src="http://radiko.jp/station/logo/'+s+'/logo_medium.png" alt="'+n+'">\n</a>');t.append(r);const l=$('<li class="mdl-menu__item mdl-pre-upgrade" station="'+s+'" data-name="'+n+'">'+n+"</li>");e.append(l),this.inputEachCard(a.find("prog"),i,s)})}}const s=new ProcessCommunicator(DlNotification);new IpcClient(DlNotification,FirebaseClient);const n=new EreaChecker,a=new e,r=new class{initialOperate(){a.init(),n.check().then(t=>(console.log(t),new ProgramListGetter(a.currentM).setAreaUrl(t).request())).then(t=>{new o(t).init(),a.setOnCardClickListener(),a.show()}).catch(t=>{(new FirebaseClient).sendError(t,"initialOperate",this.constructor.name),console.log(t)}),a.scrollTopOffset(),a.initDateMenu(),a.setOnClickListenersForFrame(),Util.setElementAsMdl($(document)),l.init()}changeDate(){a.removeAllDoms(),a.updateDateMenu(!0),n.check().then(t=>(localStorage.setItem("ereaId",t),new ProgramListGetter(a.currentM).setAreaUrl(t).request())).then(t=>{new o(t).init(),a.setOnCardClickListener(),a.show()}).catch(t=>{(new FirebaseClient).sendError(t,"initialOperate",this.constructor.name),console.log(t)})}startChangeToStationTable(t,e){a.setOnLoadingMode(),a.resetAllDoms(),new ProgramListGetter(a.currentM).setStationUrl(t).request().then(t=>{new i(t).init(),a.setOnCardClickListener(),a.updateDateMenu(!1),a.show(),a.scrollToMostRight();const e=$(".mdl-layout__content");e.scrollLeft(e.width())}).catch(t=>{console.log(t),(new FirebaseClient).sendError(t,"startChangeToStationTable",this.constructor.name)}),a.disableStMenuItem(t)}},l=new class extends ProgramSearcher{goSubmit(t){console.log("goSubmit"),window.location.href="../search/index.html?key="+t}};r.initialOperate(),$(window).on("click",t=>{if(console.log("Im clicked",t.clientX,t.clientY),a.$dialog.prop("open")){const e=a.$dialog[0].getBoundingClientRect();if(!Util.isInRect(e,t))return a.$dialog[0].close(),!1}else{const t=l.$dropDown.find(".mouseover");if(t.length)return l.resetSuggestion(t.text()),!1}})});
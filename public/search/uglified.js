"use strict";const $=require("jquery");require("bootstrap"),require("bootstrap-notify");const dialogPolyfill=require("dialog-polyfill"),ProgramSearcher=require("../../modules/ProgramSearcher"),ProcessCommunicator=require("../../modules/ProcessCommunicator"),IpcClient=require("../../modules/IpcClient"),DlNotification=require("../../modules/DlNotification"),FirebaseClient=require("../../modules/FirebaseClient"),Util=require("../../modules/Util");window.eval=global.eval=function(){throw new Error("Sorry, this app does not support window.eval().")},$(()=>{class t{constructor(){this.currentM=d(),this.$dialog=$(".mdl-dialog")}init(){const t=this;Util.setUpDialog(dialogPolyfill,this.$dialog[0]),Util.setDialogListeners(this.$dialog[0]),$("#dl-btm").on("click",()=>{t.$dialog[0].close();const e=t.$dialog.attr("ft"),i=t.$dialog.attr("station"),s=t.$dialog.attr("data-title"),n=t.$dialog.attr("to"),r=t.$dialog.attr("data-img");console.log(n),m.callDL(e,n,i,s,r)})}static checkUrlParam(){e.getUrlParam("key")&&(g.$keyInput.val(e.getUrlParam("key")).parents(".mdl-textfield").addClass("is-dirty"),$("#date-form .mdl-menu__item").eq(0).click(),g.$searchBtn.click())}setOnClickForWindow(){const t=this;$(window).on("click",e=>{if(u.$dropDown.is(":visible")){const t=u.$dropDown[0].getBoundingClientRect();if(!Util.isInRect(t,e))return u.$dropDown.hide(),!1}else if(t.$dialog.prop("open")){const i=t.$dialog[0].getBoundingClientRect();if(!Util.isInRect(i,e))return t.$dialog[0].close(),!1}return!0})}}class e{constructor(){this.$keyInput=$("#prg-search"),this.$suggestDiv=$("#suggest-drop-down"),this.$searchBtn=$("#first-row .btn"),this.momentOpe=p.currentM.clone(),this.noInput=!0}initializeSearchBar(){c=new s("#dp-ul .mdl-menu__item","#date-form .mdl-menu__container","#date-input","#dp-btn",this.momentOpe).init().setOnDateSelected(),h=new n("#end-dp-ul .mdl-menu__item","#end-form .mdl-menu__container","#end-input","#end-dp-btn",this.momentOpe).init().setOnDateSelected(),this.initKeyInput(),this.setOnClickBtnListener(),this.initSuggester()}initSuggester(){(u=new a).init();const t=this;this.$suggestDiv.on("click",t=>(u.onClickWindow(),!1)),$(window).on("resize",()=>{t.$suggestDiv.width(t.$keyInput.width())})}initDateMenu(t,e,i,s){const n=$(t),r=$(i),o=$(s);this.momentOpe.add(-8,"d");for(let t=0;t<8;t++){const e=this.momentOpe.format("M/D")+"("+Util.getWeekDays()[this.momentOpe.day()]+")";0===t&&r.val(e);const i=this.momentOpe.format("YYYYMMDD");n.eq(t).attr("date",i).html(e),this.momentOpe.add(1,"d")}r.on("click",()=>(o.click(),!1))}initKeyInput(){this.$keyInput.on("keyup",t=>{if(this.noInput&&($(t.currentTarget).attr("required","required"),this.noInput=!1),!$(t.currentTarget).val().length)return console.log("こっち"),!1})}static getUrlParam(t){return new URL(window.location.href).searchParams.get(t)}setOnClickBtnListener(){return this.$searchBtn.on("click",()=>{const t=this.$keyInput;if(!t.val().length)return this.noInput&&(this.$keyInput.attr("required","required"),this.noInput=!1,t.parents(".mdl-textfield").addClass("is-invalid")),!1;this.$suggestDiv.length&&this.$suggestDiv.remove();let e=d(c.getSelectedYmd(),"YYYYMMDD"),i=d(h.getSelectedYmd(),"YYYYMMDD");return console.log(e,i),f.requestMeta=new o(e,i,t.val()),f.onPreRequest().requestJson(),!1}),this}}class i{constructor(t,e,i,s,n){this.$dateMenuItem=$(t),this.$menuContainer=$(e),this.$dateInput=$(i),this.$dpBtn=$(s),this.momentOpe=n.clone()}init(){this.momentOpe.add(-7,"d");const t=this.$menuContainer.find(".is-selected").index();for(let e=0;e<8;e++){const i=this.momentOpe.format("M/D")+"("+Util.getWeekDays()[this.momentOpe.day()]+")";e===t&&this.$dateInput.val(i);const s=this.momentOpe.format("YYYYMMDD");this.$dateMenuItem.eq(e).attr("date",s).html(i),this.momentOpe.add(1,"d")}return this.$dateInput.on("click",()=>(this.$dpBtn.click(),!1)).focusin(t=>{$(t.currentTarget).blur()}),this}setOnDateSelected(){throw new Error("this method must override")}onDateSelectedAsDefault(t){this.$menuContainer.removeClass("is-visible").find(".is-selected").removeAttr("disabled").removeClass("is-selected"),t.attr("disabled",!0).addClass("is-selected"),this.$dateInput.val(t.html())}getDateMenuItem(){return this.$dateMenuItem}getSelectedYmd(){return this.$menuContainer.find(".is-selected").attr("date")}}class s extends i{setOnDateSelected(){const t=this;return this.getDateMenuItem().on("click",function(){t.onDateSelectedAsDefault($(this));const e=$(this).index();e>h.getDateMenuItem().parent().find(".is-selected").index()&&h.getDateMenuItem().eq(e).click();for(let t=0;t<7;t++)t<e?h.getDateMenuItem().eq(t).hide():h.getDateMenuItem().eq(t).show();return!1}),this}}class n extends i{setOnDateSelected(){const t=this;return this.getDateMenuItem().on("click",function(){return t.onDateSelectedAsDefault($(this)),!1}),this}}class r{constructor(){this.$spinner=$("#spinner-1st"),this.$resultGroup=$(".result"),this.$cardGroup=$("#card-group"),this.$cardGroupIn=$("#card-group-in"),this.$btmSpinWrapper=$("#bottom-spinner"),this.$errResult=$("#err-result"),this.$nonResult=$("#non-result"),this.$suggestResult=$("#suggest-word"),this.$suggestA=this.$suggestResult.find("a"),this.uid=Util.generateUid(),this.requestMeta=null,this.init()}init(){this.$suggestA.on("click",t=>{const e=$(t.currentTarget).html();return g.$keyInput.val(e),!1});const t=this,e=$(".mdl-layout__header-row");$(".mdl-layout__content").scroll(i=>{t.$btmSpinWrapper.is(":visible")&&$(i.currentTarget).height()+e.height()-t.$btmSpinWrapper.offset().top>32&&(t.requestMeta.pageIndex++,t.requestJson(),t.$btmSpinWrapper.css("display","none"))})}onPreRequest(){return this.$resultGroup.hide(),this.$spinner.addClass("is-active"),this.$cardGroupIn.empty(),this}requestJson(){const t=localStorage.getItem("ereaId"),e="http://radiko.jp/v3/api/program/search?key="+encodeURIComponent(this.requestMeta.key)+"&filter=past&start_day="+this.requestMeta.startM.format("YYYY-MM-DD")+"&end_day="+this.requestMeta.endM.format("YYYY-MM-DD")+"&area_id="+t+"&region_id=&cul_area_id="+t+"&page_idx="+this.requestMeta.pageIndex+"&uid="+this.uid+"&row_limit="+this.requestMeta.rowLimit+"&app_id=pc&action_id=1&action_rank=1";$.getJSON(e).done(t=>{this.onGetJson(t)}).fail((t,e,i)=>{console.log(e,i,t),this.noticeFailure()})}onGetJson(t){console.log(JSON.stringify(t));const e=this;if(t.meta.result_count)if($.each(t.data,(t,i)=>{new l(i).$card.appendTo(e.$cardGroupIn)}),Util.setElementAsMdl(e.$cardGroupIn),this.noticeCards(),t.meta.row_limit*(t.meta.page_idx+1)<t.meta.result_count)e.$btmSpinWrapper.css("display","flex");else{e.$btmSpinWrapper.css("display","none");const i=e.$cardGroupIn.width(),s=Math.floor(i/332),n=s-t.data.length%s;for(let t=0;t<n;t++)$('<div class="mdl-card mdl-shadow--2dp mdl-pre-upgrade item dummy"></div>').appendTo(e.$cardGroupIn)}else t.meta.suisengo?this.noticeSuggest(t.meta.suisengo):this.noticeNonResult()}noticeFailure(){this.hideAllResult(),this.$errResult.show()}noticeNonResult(){this.hideAllResult(),this.$nonResult.show()}noticeSuggest(t){this.hideAllResult(),this.$suggestResult.show(),this.$suggestA.html(t)}noticeCards(){this.hideAllResult(),this.$cardGroup.show()}hideAllResult(){this.$spinner.removeClass("is-active"),this.$cardGroup.hide(),this.$errResult.hide(),this.$nonResult.hide(),this.$suggestResult.hide()}static generateTimeVal(t){const e=d(t,"YYYYMMDD");return e.format("M/D")+"("+Util.getWeekDays()[e.day()]+")"}}class o{constructor(t,e,i){this.startM=t,this.endM=e,this.key=i,this.pageIndex=0,this.rowLimit=12}}class a extends ProgramSearcher{goSubmit(){g.$searchBtn.click()}}class l{constructor(t){this.stationId=t.station_id,this.performer=t.performer,this.title=t.title,this.imgUrl=t.img,this.prgDate=t.program_date,this.startTimeS=t.start_time_s,this.endTimeS=t.end_time_s,this.info=t.info,this.desc=t.description,this.tsNg=t.ts_in_ng,this.$card=this.createCardWithListener()}createCardWithListener(){const t=this,e=this.startTimeS.splice(2,0,":")+" - "+this.endTimeS.splice(2,0,":"),i=r.generateTimeVal(this.prgDate),s=2==this.tsNg?"cant-dl":"";return $('<div class="mdl-card mdl-shadow--2dp mdl-pre-upgrade item '+s+'">\n<div class="station-logo">\n<img src="http://radiko.jp/station/logo/'+this.stationId+'/logo_medium.png" alt="'+this.stationId+'">\n</div>\n<img src="'+this.imgUrl+'" class="prg-logo" alt="番組ロゴ">\n<div class="details">\n<h4 class="prg-title mdl-pre-upgrade">'+this.title+'</h4>\n<p class="prg-time mdl-pre-upgrade"><span>'+i+"</span>"+e+'</p>\n<p class="prg-pfm mdl-pre-upgrade">'+this.performer+"</p>\n</div>\n</div>").on("click",function(){if(p.$dialog.prop("open"))return;console.log("clicked"),p.$dialog.find(".prg-logo").removeAttr("src").attr("src",t.imgUrl),p.$dialog.find(".title").html(t.title),p.$dialog.find(".performer").html(t.performer),p.$dialog.find(".desc").empty().append(Util.wrapHtml(t.desc)),p.$dialog.find(".info").empty().html(Util.wrapHtml(t.info));const e=p.$dialog.find("#dl-btm"),i=p.$dialog.find(".error-msg");2==t.tsNg?(e.hide(),i.html("この番組はタイムフリー非対応です").show()):(e.show(),i.html("").hide());const s=t.prgDate+""+t.startTimeS+"00",n=t.prgDate+""+t.endTimeS+"00";return console.log(s),p.$dialog.attr("ft",s).attr("to",n).attr("station",t.stationId).attr("data-title",t.title).attr("data-img",t.imgUrl),p.$dialog[0].showModal(),!1}).hover(e=>{2!=t.tsNg&&$(e.currentTarget).addClass("is-hovered").removeClass("mdl-shadow--2dp").addClass("mdl-shadow--6dp")},e=>{2!=t.tsNg&&$(e.currentTarget).removeClass("is-hovered").addClass("mdl-shadow--2dp").removeClass("mdl-shadow--6dp")})}}const d=require("moment");let c,h,u;const m=new ProcessCommunicator(DlNotification);new IpcClient(DlNotification,FirebaseClient),$("form").on("submit",()=>!1);const p=new t;p.init();const g=new e,f=new r;g.initializeSearchBar(),p.setOnClickForWindow(),t.checkUrlParam()});
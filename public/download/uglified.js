const $=require("jquery"),remote=require("electron").remote;require("bootstrap-notify");const tippy=require("tippy.js"),Store=require("electron-store"),FirebaseClient=require("../../modules/FirebaseClient"),IpcClient=require("../../modules/IpcClient"),DlNotification=require("../../modules/DlNotification"),ipcRenderer=require("electron").ipcRenderer,Util=require("../../modules/Util");window.eval=global.eval=function(){throw new Error("Sorry, this app does not support window.eval().")},$(()=>{const t=require("moment");class e{constructor(){this.setOnReceiveListeners()}static askStatus(){console.log("askStatus()"),ipcRenderer.send("dlStatus")}static callOpenFile(){ipcRenderer.send("openFileExplore")}setOnReceiveListeners(){ipcRenderer.on("dlStatus_REPLY",(t,s)=>{e.onGetDlStatusReply(s)}).on("startDlChainError",(t,e)=>{i.onGetFfmpegError(e)}).on("pageReached",(t,e)=>{console.log(e),i.updateStage("pageReached",e.timeStamp)}).on("ffmpegStart",(t,e)=>{console.log(e),i.updateStage("ffmpegStart",e.timeStamp)}).on("ffmpegError",(t,e)=>{console.log(e),i.onGetFfmpegError(e)}).on("ffmpegEnd",(t,e)=>{console.log(e),i.onGetFfmpegEnd(e)}).on("cancelError",(e,s)=>{const i=s.title+" "+Util.getMDWithWeekDay(t(s.ft,"YYYYMMDDhhmmss"));DlNotification.showFailedNtf("処理に失敗しました",i)}).on("ExplorerErr",(t,e)=>{DlNotification.showFailedNtf("処理に失敗しました")}).on("ffmpegPrg",(t,e)=>{console.log("ffmpegPrg"),i.onGetFfmpegProgress(e)})}static onGetDlStatusReply(e){console.log(e);const n=JSON.parse(e),o=n.tasks[n.working],r=Object.keys(n.tasks);if(n.working&&r.length){for(let e=0;e<r.length;e++){console.log(r[e]);const l=n.tasks[r[e]];if(l.abortFlag)continue;const a=t(l.ft,"YYYYMMDDhhmmss"),p=Util.getMDWithWeekDay(a)+" "+a.format("hh:mm")+" - "+t(l.to,"YYYYMMDDhhmmss").format("hh:mm"),c=DlNotification.getStageStr(l.stage),m=s.createDlItem(r[e],l.title,p,c,l.img);if(console.log(o,r[e]),n.working==r[e]){if("ffmpegError"===o.stage){DlNotification.showFailedNtf("処理に失敗しました",l.title);continue}if("ffmpegEnd"===o.stage){DlNotification.showSuccessNtf("ダウンロード完了",l.title);continue}i.$taskList.prepend(m),Util.setElementAsMdl(m)}else i.$taskList.append(m);Util.setElementAsMdl(m),tippy(m.find(".mdl-button")[0]);const u=m.find(".mdl-progress")[0];if(n.working==r[e]){const t=DlNotification.getStageNum(l.stage);u.MaterialProgress.setProgress(t)}else u.MaterialProgress.setBuffer(90)}Util.setElementAsMdl(i.$taskList),i.setOnClickCancel()}else $("#non-list").show()}}class s{constructor(){this.$input=$("#file-location .mdl-textfield"),this.$taskList=$("#task-list ul"),this.$pathInput=$("#path-input"),this.$bpsInput=$("#bit-rate-input"),this.$sufInput=$("#suf-input"),this.store=new Store,this.bpsArr=["64kbps","128kbps","160kbps","256kbps","320kbps"],this.sufArr=["mp3","m4a","aac","wav","flac"],this.$bitRateMenu=$("#bit-rate .mdl-menu"),this.$sufMenu=$("#suffix .mdl-menu"),this.suf=this.store.get("suffix")||"mp3",this.bps=this.store.get("kbps")||"128kbps"}init(){$("#dpdn").on("click",t=>{const e=remote.BrowserWindow.getFocusedWindow();return remote.dialog.showOpenDialog(e,{properties:["openDirectory"],title:"ダウンロードフォルダ",defaultPath:"."},t=>{t&&(this.store.set("output_path",t[0]),DlNotification.showCancelNtf("保存先を更新しました"),console.log(this.store.get("output_path")))}),!1}),$("input").focus(t=>($(t.currentTarget).blur(),!1));const t=this.store.get("suffix")||"mp3",s=this.store.get("kbps")||"128kbps";console.log(t,s),this.$pathInput.val(this.store.get("output_path")),this.$bpsInput.val(s),this.$sufInput.val(t),this.buildRateMenu(),this.buildSufMenu(),tippy("#open-dir-btn"),$("#open-dir-btn").on("click",()=>(e.callOpenFile(),!1))}buildSufMenu(){for(let t=0;t<this.sufArr.length;t++){const e=this.sufArr[t]===this.suf?"disabled":"";$('<li class="mdl-menu__item mdl-pre-update" '+e+">"+this.sufArr[t]+"</li>").on("click",e=>{this.$sufInput.val(this.sufArr[t]),this.suf=this.sufArr[t],this.store.set("suffix",this.sufArr[t]),this.$sufMenu.empty(),this.buildSufMenu()}).appendTo(this.$sufMenu)}Util.setElementAsMdl(this.$sufMenu)}buildRateMenu(){for(let t=0;t<this.bpsArr.length;t++){const e=this.bpsArr[t]===this.bps?"disabled":"";$('<li class="mdl-menu__item mdl-pre-update" '+e+">"+this.bpsArr[t]+"</li>").on("click",e=>{this.$bpsInput.val(this.bpsArr[t]),this.bps=this.bpsArr[t],this.store.set("kbps",this.bpsArr[t]),this.$bitRateMenu.empty(),this.buildRateMenu()}).appendTo(this.$bitRateMenu)}Util.setElementAsMdl(this.$bitRateMenu)}static createDlItem(t,e,s,i,n){return $('<li data-time-stamp="'+t+'">\n<div class="wrapper">\n<img src="'+n+'" alt="番組ロゴ" class="prg-logo">\n<div class="main-row">\n<div class="main-row-in">\n<p class="prg-title">'+e+'</p>\n<span class="prg-time">'+s+'</span>\n<div class="mdl-progress mdl-js-progress mdl-pre-upgrade"></div>\n<span class="stage">'+i+'</span>\n</div>\n<button class="mdl-button mdl-js-button mdl-button--icon cancel-btn mdl-pre-upgrade cancel-btn" title="ダウンロードをキャンセル">\n<i class="material-icons">clear</i>\n</button>\n</div>\n</div>\n</li>')}setOnClickCancel(){const t=this;this.$taskList.find(".cancel-btn").on("click",e=>{const s=$(e.currentTarget).parents("li"),i=s.attr("data-time-stamp");console.log("キャンセル timeStamp",i),t.removeItem(s),DlNotification.showCancelNtf("キャンセルしました"),ipcRenderer.send("cancelDl",i)})}removeItem(t){t.animate({opacity:"0"},500,()=>{t.animate({height:"0"},500,()=>{t.remove()})});const e=this.$taskList.find("li:not(#non-list)");e.length&&e.find(".mdl-progress")[0].MaterialProgress.setBuffer(100)}updateStage(t,e){const s=this.$taskList.find('li[data-time-stamp="'+e+'"]');if(!s.length)return;const i=DlNotification.getStageStr(t),n=DlNotification.getStageNum(t);s.find(".mdl-progress")[0].MaterialProgress.setProgress(n),s.find(".stage").html(i)}onGetFfmpegEnd(e){const s=this.$taskList.find('li[data-time-stamp="'+e.timeStamp+'"]');this.updateStage("ffmpegEnd",e.timeStamp),this.removeItem(s);const i=e.title+" "+Util.getMDWithWeekDay(t(e.ft,"YYYYMMDDhhmmss"));DlNotification.showSuccessNtf("ダウンロード完了",i)}onGetFfmpegError(e){const s=this.$taskList.find('li[data-time-stamp="'+e.timeStamp+'"]');this.updateStage("ffmpegError",e.timeStamp),this.removeItem(s),console.log(e.ft);const i=e.title+" "+Util.getMDWithWeekDay(t(e.ft,"YYYYMMDDhhmmss"));DlNotification.showFailedNtf("処理に失敗しました",i)}onGetFfmpegProgress(t){console.log("timeStamp",t.timeStamp);const e=this.$taskList.find('li[data-time-stamp="'+t.timeStamp+'"]');if(!e.length)return void console.log("てってれー");const s=(new DlNotification).calcProgressNum(t),i=DlNotification.getStageStr("ffmpegPrg",s);console.log("numnum",s),e.find(".mdl-progress")[0].MaterialProgress.setProgress(s),e.find(".stage").html(i)}}const i=new s;new e,new IpcClient(DlNotification,FirebaseClient),class{static init(){i.init(),e.askStatus()}}.init()});
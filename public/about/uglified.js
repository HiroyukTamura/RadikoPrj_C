const $=require("jquery"),tippy=require("tippy.js");require("bootstrap-notify");const FirebaseClient=require("../../modules/FirebaseClient"),IpcClient=require("../../modules/IpcClient"),DlNotification=require("../../modules/DlNotification"),Util=require("../../modules/Util"),{EreaChecker:EreaChecker}=require("../../modules/Network");window.eval=global.eval=function(){throw new Error("Sorry, this app does not support window.eval().")},$(()=>{const e=require("moment");class t{init(){const e=EreaChecker.getAreaIdFromStorage();console.log(e),e&&"undefined"!==e?new o(e).request().then(e=>{t.onGetInfoData(e)}).catch(e=>{(new FirebaseClient).sendError(e,t.init.name,this.constructor.name),console.log(e),$("#notice-radiko .error-big").show()}):(new EreaChecker).check().then(e=>(console.log("こっち",e),new o(e).request())).then(e=>{t.onGetInfoData(e)}).catch(e=>{(new FirebaseClient).sendError(e,t.init.name,this.constructor.name),console.log(e),$("#notice-radiko .error-big").show()}),this.getOriginalInfo()}static onGetInfoData(t){console.log(t);const n=$(t).find("info");for(let t=0;t<n.length;t++){console.log(t);const o=n.eq(t),r=o.find("date").html(),s=e(r,"YYYY.MM.DD");if(e().diff(s,"months")>=1)break;const a=s.format("YYYY年M月D日")+"("+Util.getWeekDays()[s.day()]+")",l=o.find("title").html(),c=Util.wrapHtml(o.find("body").html()).html();i.appendRdkInfoItem(a,l,c)}}getOriginalInfo(){const e=new FirebaseClient;e.getNotice().then(e=>{this.onGetOriginalInfo(e)}).catch(t=>{console.log(t),e.sendError(t,"getOriginalInfo",this.constructor.name),n.showOriginalInfoErr("データの取得に失敗しました")})}onGetOriginalInfo(t){t.empty?n.showOriginalInfoErr("お知らせはありません"):t.forEach(t=>{const n=e(t.id,"YYYYMMDD").format("YYYY年M月D日"),o=t.get("value");i.inputCardInfo(t.get("title"),o,n)})}}class n{constructor(){this.$rdkNtfW=$("#notice-radiko"),this.$input=$("#comment"),this.$noticeSec=$("#notice"),tippy("#send-btn"),this.setBtnClick()}setBtnClick(){$("#send-btn").on("click",()=>{const e=this.$input.val();if(!e)return this.$input.parent().addClass("is-invalid"),!1;const t=new FirebaseClient;return t.setUserData(),t.comment=e,t.writeData("contact-comment").then(()=>{DlNotification.showCancelNtf("送信しました")}).catch(e=>{console.log(e),DlNotification.showFailedNtf("処理に失敗しました")}),!1})}appendRdkInfoItem(e,t,n){$('<div class="mdl-card mdl-shadow--2dp mdl-pre-upgrade"><p class="news-detail__date">'+e+'</p><h4 class="news-detail__title">'+t+'</h4><div class="news-detail__content">'+n+"</div>").appendTo(this.$rdkNtfW)}inputCardInfo(e,t,n){$('<div class="mdl-card mdl-shadow--2dp">\n<h4>'+e+'</h4>\n<div class="news-detail__content">'+t+'</div>\n<p class="date-btm">'+n+"</p>\n</div>").appendTo(this.$noticeSec)}static showOriginalInfoErr(e){$("#notice.error-big p").html(e),$("#notice.error-big").show()}}class o{constructor(e){console.log(e),this.URL="http://radiko.jp/v2/information2/"+e+".xml"}request(){return new Promise((e,t)=>{$.ajax({url:this.URL,cache:!1}).done((t,n,o)=>{e(t)}).fail((e,n,o)=>{console.log("fail",e.status,n),t(o)})})}}const i=new n;new IpcClient,(new t).init()});